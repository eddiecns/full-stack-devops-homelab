- name: Verify SSH key-only auth is enabled
  command: sshd -T
  register: sshd_config
  changed_when: false

- name: Assert password authentication is disabled
  assert:
    that:
      - "'passwordauthentication no' in sshd_config.stdout"

- name: Assert root login is disabled
  command: sshd -T -C user=root,host=localhost,addr=127.0.0.1
  register: sshd_config

- assert:
    that:
      - "'permitrootlogin yes' in sshd_config.stdout"

- name: Verify cloud-init is installed
  package:
    name: cloud-init
    state: present

- name: Verify qemu-guest-agent is running
  systemd:
    name: qemu-guest-agent
    state: started
    enabled: true

- name: Verify sudo is passwordless for wheel
  command: sudo -n whoami
  register: sudo_check
  changed_when: false

- name: Assert sudo works without password
  assert:
    that:
      - sudo_check.stdout == "root"

- name: Get active NetworkManager connections
  command: nmcli -g NAME connection show --active
  register: nmcli_active_conns
  changed_when: false

- name: Check IPv4 method for non-loopback connections
  command: nmcli -g ipv4.method connection show "{{ item }}"
  loop: "{{ nmcli_active_conns.stdout_lines }}"
  when: item != "lo"
  register: nmcli_ipv4_methods
  changed_when: false

- name: Assert all non-loopback connections use DHCP
  assert:
    that:
      - item.stdout == "auto"
    fail_msg: "Connection {{ item.item }} is not using DHCP"
    success_msg: "Connection {{ item.item }} is using DHCP"
  loop: "{{ nmcli_ipv4_methods.results }}"
  when:
    - item.stdout is defined

- name: Pause before final cleanup
  pause:
    prompt: |
      Validation passed.
      This VM will be powered off and must NEVER be started again.
      Press ENTER to continue or Ctrl+C to abort.
